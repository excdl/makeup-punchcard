<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ‰“å¡ç´€éŒ„</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2.21/sdk.js"></script>
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #999; padding: 5px; text-align: center; }
  th { background-color: #eee; }
</style>
</head>
<body>

<h3 id="userInfo">è¼‰å…¥ä¸­...</h3>

<div>
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate">
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate">
  <button id="btnSearch">æŸ¥è©¢</button>
  <button id="btnClear">æ¸…é™¤</button>
</div>

<div>
  æ—¥æœŸï¼š<input type="date" id="makeupDate">
  æ™‚é–“ï¼š<input type="time" id="makeupTime">
  <select id="makeupStatus">
    <option value="ä¸Šç­">ä¸Šç­</option>
    <option value="ä¸‹ç­">ä¸‹ç­</option>
  </select>
  <button id="btnMakeup">é€å‡ºç”³è«‹</button>
</div>

<table>
  <thead>
    <tr>
      <th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>ç‹€æ…‹</th><th>æ‰“å¡æ–¹å¼</th>
      <th>IP</th><th>å…¬å¸ä½ç½®</th><th>è·é›¢</th><th>æ‰“å¡ç‹€æ…‹</th><th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="recordTable">
    <tr><td colspan="9">è¼‰å…¥ä¸­...</td></tr>
  </tbody>
</table>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzdwGiG5cqi2uxNEdML0OFaF9bWpUYuAPoN5s2Th8fSYF9xe_XOwLD7n3aCyA98EmHd/exec";
let userId = "", userName = "";

// æ—¥æœŸæ™‚é–“æ ¼å¼
function fixDate(t){
  if(!t) return "";
  if(typeof t==="string" && t.includes("/")) return t;
  if(typeof t==="string" && t.includes("T")){
    const d=new Date(t);
    return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
  }
  return t;
}
function fixTime(t){
  if(!t) return "";
  if(typeof t==="string" && t.includes(":") && !t.includes("T")) return t;
  if(typeof t==="string" && t.includes("T")){
    const d=new Date(t);
    return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
  }
  return t;
}

// LIFF åˆå§‹åŒ–
async function initLIFF(){
  try{
    await liff.init({ liffId: "2008786085-L1CtKqqv" });
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${userName} æ‚¨å¥½`;
    loadRecords();
  }catch(err){
    console.error("LIFF åˆå§‹åŒ–å¤±æ•—:", err);
    document.getElementById("userInfo").textContent = "è¼‰å…¥å¤±æ•—";
  }
}

// æœ¬æœˆç¬¬ä¸€å¤©èˆ‡ä»Šå¤©
function getMonthRange() {
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");
  return [`${yyyy}-${mm}-01`, `${yyyy}-${mm}-${dd}`];
}

// å–å¾—æ‰“å¡ç´€éŒ„
async function loadRecords(start="", end=""){
  const tbody = document.getElementById("recordTable");
  tbody.innerHTML="<tr><td colspan='9'>è¼‰å…¥ä¸­...</td></tr>";
  try{
    let [sDate,eDate] = start && end ? [start,end] : getMonthRange();
    const res = await fetch(`${API_ENDPOINT}?action=getRecords&userId=${userId}&start=${sDate}&end=${eDate}`);
    let data = await res.json();
    if(!data || !data.length){
      tbody.innerHTML="<tr><td colspan='9'>ç„¡ç´€éŒ„</td></tr>";
      return;
    }
    // ğŸ”¹æ’åºï¼šå…ˆæŒ‰æ—¥æœŸï¼Œå†æŒ‰æ™‚é–“ï¼Œæœ€æ–°åœ¨å‰
    data.sort((a,b)=>{
      const dtA = new Date(`${a.date}T${a.time}`);
      const dtB = new Date(`${b.date}T${b.time}`);
      return dtB - dtA;
    });
    tbody.innerHTML = data.map(r=>`
      <tr>
        <td>${fixDate(r.date)}</td>
        <td>${fixTime(r.time)}</td>
        <td>${r.status}</td>
        <td>${r.method}</td>
        <td>${r.ip}</td>
        <td>${r.nearestCompany || ""}</td>
        <td>${r.distance || ""}</td>
        <td>${r['æ‰“å¡ç‹€æ…‹']}</td>
        <td>${r.status==="è«‹å‡" ? `<button onclick="makeup('${r.KEY_ID}')">è£œæ‰“å¡</button>` : ""}</td>
      </tr>
    `).join("");
  }catch(err){
    console.error("è®€å–ç´€éŒ„å¤±æ•—:", err);
    tbody.innerHTML="<tr><td colspan='9'>è®€å–å¤±æ•—</td></tr>";
  }
}

// è£œæ‰“å¡å‡½å¼
async function makeup(keyId){
  try{
    const { value: formValues } = await Swal.fire({
      title: 'è£œæ‰“å¡è¨­å®š',
      html: `<input type="time" id="makeupTime"> 
             <select id="makeupStatus">
               <option value="ä¸Šç­">ä¸Šç­</option>
               <option value="ä¸‹ç­">ä¸‹ç­</option>
             </select>`,
      focusConfirm: false,
      showCancelButton: true,
      preConfirm: ()=>{
        return {
          time: document.getElementById("makeupTime").value,
          status: document.getElementById("makeupStatus").value
        }
      }
    });
    if(formValues){
      const res = await fetch(API_ENDPOINT, {
        method: "POST",
        body: JSON.stringify({ action:"makeup", userId, keyId, time: formValues.time, status: formValues.status })
      });
      const data = await res.json();
      Swal.fire({icon:"success",title:data.message || "è£œæ‰“å¡å®Œæˆ",timer:1500,showConfirmButton:false});
      loadRecords();
    }
  }catch(err){
    console.error("è£œæ‰“å¡å¤±æ•—:", err);
    Swal.fire({icon:"error",title:"è£œæ‰“å¡å¤±æ•—",timer:1500,showConfirmButton:false});
  }
}

// è£œæ‰“å¡ç”³è«‹
document.getElementById("btnMakeup").onclick = async ()=>{
  const date = document.getElementById("makeupDate").value;
  const time = document.getElementById("makeupTime").value;
  const status = document.getElementById("makeupStatus").value;
  if(!date || !time){
    return Swal.fire({icon:"info", title:"è«‹å¡«å¯«å®Œæ•´æ—¥æœŸèˆ‡æ™‚é–“", timer:1500, showConfirmButton:false});
  }
  const keyId = `${date}-${userId}-${status}`;
  try{
    const res = await fetch(API_ENDPOINT, {
      method:"POST",
      body: JSON.stringify({ action:"makeup", userId, date, keyId, time, status })
    });
    const data = await res.json();
    Swal.fire({icon:"success", title:data.message || "è£œæ‰“å¡ç”³è«‹å®Œæˆ", timer:1500, showConfirmButton:false});
    loadRecords();
  }catch(err){
    console.error(err);
    Swal.fire({icon:"error", title:"è£œæ‰“å¡ç”³è«‹å¤±æ•—", timer:1500, showConfirmButton:false});
  }
};

// ç¯©é¸æŒ‰éˆ•
document.getElementById("btnSearch").onclick = ()=>{
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if(!start || !end) return Swal.fire({icon:"info",title:"è«‹é¸æ“‡å®Œæ•´æ—¥æœŸç¯„åœ",timer:1500,showConfirmButton:false});
  loadRecords(start,end);
};
document.getElementById("btnClear").onclick = ()=>{
  document.getElementById("startDate").value="";
  document.getElementById("endDate").value="";
  loadRecords();
};

// å•Ÿå‹•
window.onload = initLIFF;
</script>

</body>
</html>
