<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>考勤紀錄</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:Arial;padding:20px;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#f4f4f4;}
.waiting{color:orange;font-weight:bold;}
</style>
</head>
<body>

<h2 id="userInfo">載入中...</h2>

<h3>補打卡申請</h3>

日期：
<input type="date" id="makeupDate">

時間：
<input type="time" id="makeupTime">

狀態：
<select id="makeupStatus">
  <option value="上班">上班</option>
  <option value="下班">下班</option>
</select>

補打卡原因：
<input type="text" id="makeupReason" placeholder="請輸入原因">

<button onclick="makeup()">送出申請</button>

<hr>

<table>
<thead>
<tr>
  <th>日期</th>
  <th>時間</th>
  <th>狀態</th>
  <th>公司位置</th>
  <th>打卡狀態</th>
  <th>補打卡</th>
  <th>補打原因</th>
</tr>
</thead>
<tbody id="recordTable">
<tr><td colspan="7">載入中...</td></tr>
</tbody>
</table>

<script>

const API = "https://script.google.com/macros/s/AKfycbxuK66hkJihSWFX8MHk8RE8u9EY_-1P1v4oJKkJRsJoK5zO5JgUJphGSPqwQWFU1p8e/exec";
let userId="";
let userName="";

// 正確時間顯示
function fixTime(t){
  if(!t) return "";
  if(typeof t==="string" && t.includes("T")){
    return t.substring(11,19);
  }
  return t;
}

async function init(){
  await liff.init({ liffId:"你的LIFFID" });
  if(!liff.isLoggedIn()) liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;
  document.getElementById("userInfo").innerText = userName+" 您好";
  load();
}

async function load(){
  const res = await fetch(`${API}?action=getRecords&userId=${userId}`);
  const data = await res.json();
  const tbody = document.getElementById("recordTable");

  if(!data.length){
    tbody.innerHTML="<tr><td colspan='7'>無紀錄</td></tr>";
    return;
  }

  tbody.innerHTML = data.map(r=>`
<tr>
  <td>${r.date}</td>
  <td>${fixTime(r.time)}</td>
  <td>${r.status||""}</td>
  <td>${r.nearestCompany||""}</td>
  <td>${r.打卡狀態||""}</td>
  <td class="${r.補打卡==='待審核'?'waiting':''}">
      ${r.補打卡||""}
  </td>
  <td>${r.補打卡原因||""}</td>
</tr>
`).join("");
}

async function makeup(){

  let date = document.getElementById("makeupDate").value.replace(/-/g,"/");
  let time = document.getElementById("makeupTime").value;
  let status = document.getElementById("makeupStatus").value;
  let reason = document.getElementById("makeupReason").value.trim();

  if(!reason){
    Swal.fire({icon:"warning",title:"請填寫補打卡原因"});
    return;
  }

  if(time.split(":").length===2){
    time+=":00";
  }

  const res = await fetch(API,{
    method:"POST",
    body: JSON.stringify({
      action:"makeup",
      userId,
      userName,
      date,
      time,
      status,
      reason
    })
  });

  const data = await res.json();
  Swal.fire({icon:"success",title:data.message,timer:1500,showConfirmButton:false});
  document.getElementById("makeupReason").value="";
  load();
}

window.onload=init;

</script>
</body>
</html>
