<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>考勤紀錄</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:Arial,sans-serif;padding:20px;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#f4f4f4;}
input,button,select{padding:5px;margin:5px;}
.waiting{color:orange;font-weight:bold;}
</style>
</head>
<body>

<h2 id="userInfo">載入中...</h2>

<div>
  日期篩選：
  <input type="date" id="startDate"> 至 
  <input type="date" id="endDate">
  <button id="btnSearch">查詢</button>
  <button id="btnClear">清除</button>
</div>

<div style="margin-top:10px; border:1px solid #ccc; padding:10px;">
  <h4>加補打卡申請：</h4>
  日期：<input type="date" id="makeupDate">  
  時間：<input type="time" id="makeupTime">  
  狀態：
  <select id="makeupStatus">
    <option value="上班">上班</option>
    <option value="下班">下班</option>
  </select>

  補打卡原因：
  <input type="text" id="makeupReason" placeholder="請輸入補打卡原因">

  <button id="btnMakeup">送出申請</button>
</div>

<table>
  <thead>
    <tr>
      <th>日期</th>
      <th>時間</th>
      <th>狀態</th>
      <th>公司位置</th>
      <th>打卡狀態</th>
      <th>補打卡</th>
      <th>補打原因</th>
    </tr>
  </thead>
  <tbody id="recordTable">
    <tr><td colspan='7'>載入中...</td></tr>
  </tbody>
</table>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwcEwUF278_nwfqfpVhp01iEShL1iAyTB_TJC7N-jXQ8OV7RCotFy9wJgME4N9WVH5m/exec";
let userId = "";
let userName = "";

function fixDate(t){
  if(!t) return "";
  if(typeof t==="string" && t.includes("/")) return t;
  if(typeof t==="string" && t.includes("T")){
    const d=new Date(t);
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}/${mm}/${dd}`;
  }
  return t;
}

function fixTime(t){
  if(!t) return "";
  return t.length === 5 ? t + ":00" : t; // 確保時間格式為 "HH:mm:ss"
}
async function initLIFF(){
  try{
    await liff.init({ liffId: "2008786085-L1CtKqqv" });
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${userName} 您好`;

    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
    const lastDay  = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().slice(0,10);
    document.getElementById("startDate").value = firstDay;
    document.getElementById("endDate").value = lastDay;
    loadRecords(firstDay,lastDay);

  }catch(err){
    console.error(err);
    document.getElementById("userInfo").textContent = "無法取得使用者資訊，請在 LINE 打開此頁面。";
  }
}

async function loadRecords(start="", end=""){
  const tbody = document.getElementById("recordTable");
  tbody.innerHTML="<tr><td colspan='7'>載入中...</td></tr>";
  try{
    const sDate = start || new Date().toISOString().slice(0,10);
    const eDate = end || sDate;

    const res = await fetch(`${API_ENDPOINT}?action=getRecords&userId=${userId}&start=${sDate}&end=${eDate}`);
    const data = await res.json();

    if(!data.length){
      tbody.innerHTML="<tr><td colspan='7'>無紀錄</td></tr>";
      return;
    }

    tbody.innerHTML = data.map(r=>`
      <tr>
        <td>${fixDate(r.date)}</td>
        <td>${fixTime(r.time)}</td>
        <td>${r.status||""}</td>
        <td>${r.nearestCompany||""}</td>
        <td>${r.打卡狀態||""}</td>
        <td class="${r.補打卡==='待審核'?'waiting':''}">
            ${r.補打卡||""}
        </td>
        <td>${r.補打卡原因||""}</td>
      </tr>
    `).join("");

  }catch(err){
    console.error(err);
    tbody.innerHTML="<tr><td colspan='7'>讀取失敗</td></tr>";
  }
}

// 補打卡申請
document.getElementById("btnMakeup").onclick = async ()=>{

  let date = document.getElementById("makeupDate").value.replace(/-/g,"/");
  let time = document.getElementById("makeupTime").value;
  if(time.split(":").length===2) time+=":00";
  const status = document.getElementById("makeupStatus").value;
  const reason = document.getElementById("makeupReason").value.trim();

  if(!date || !time || !status || !reason)
    return Swal.fire({icon:"info",title:"請填完整資料",timer:1500,showConfirmButton:false});

  try{
    const res = await fetch(API_ENDPOINT,{
      method:"POST",
      body: JSON.stringify({ 
        action:"makeup", 
        userId, 
        userName, 
        date, 
        time, 
        status,
        reason
      })
    });

    const data = await res.json();
    Swal.fire({icon:"success",title:data.message||"補打卡完成",timer:1500,showConfirmButton:false});
    document.getElementById("makeupReason").value="";
    loadRecords();

  }catch{
    Swal.fire({icon:"error",title:"補打卡失敗",timer:1500,showConfirmButton:false});
  }
};

document.getElementById("btnSearch").onclick = ()=>{
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if(!start||!end) return Swal.fire({icon:"info",title:"請選擇完整日期範圍",timer:1500,showConfirmButton:false});
  loadRecords(start,end);
};

document.getElementById("btnClear").onclick = ()=>{
  document.getElementById("startDate").value="";
  document.getElementById("endDate").value="";
  loadRecords();
};

window.onload = initLIFF;
</script>
</body>
</html>
